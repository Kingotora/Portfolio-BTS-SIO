
// =========================================
//  LANG TOGGLE (FR/EN) - GLOBAL
// =========================================
const langBtn = document.getElementById('langToggle');

// Translations are now loaded from js/lang.js

let currentLang = localStorage.getItem('lang') || 'fr';

function updateLang() {
  // 1. Update Language Button
  const icon = langBtn?.querySelector('.lang-icon');
  if (icon) {
    icon.textContent = currentLang === 'fr' ? 'FR' : 'EN';
    icon.style.filter = 'none';
  }

  // 2. Parse all elements with data-i18n
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    const text = translations[currentLang][key];

    if (text) {
      if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
        el.placeholder = text;
      } else {
        el.innerHTML = text;
      }
    }
  });

  // 3. Update Typing Effect (if on Home)
  const subtitle = document.querySelector('.subtitle');
  if (subtitle) {
    // Reset animation by removing/adding class
    subtitle.style.animation = 'none';
    subtitle.offsetHeight; /* trigger reflow */
    subtitle.style.animation = null;
  }

  // 4. Re-render projects if function exists (to update language in dynamic cards)
  if (typeof renderProjects === 'function') {
    renderProjects();
  }
}

// Event Listener
if (langBtn) {
  langBtn.addEventListener('click', () => {
    currentLang = currentLang === 'fr' ? 'en' : 'fr';
    localStorage.setItem('lang', currentLang);
    updateLang();
  });
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  updateLang();
  if (typeof renderProjects === 'function') renderProjects();
});


// =========================================
//  SCROLL INDICATOR
// =========================================
window.addEventListener('scroll', () => {
  const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
  const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
  const scrolled = (winScroll / height) * 100;

  const bar = document.getElementById("scrollProgress");
  if (bar) bar.style.width = scrolled + "%";
});


// =========================================
//  THEME TOGGLE
// =========================================
const themeBtn = document.getElementById('themeToggle');
const body = document.body;
// Check local storage or system preference
// Default is Dark (no class). 'light' theme adds .light-mode
let isLight = localStorage.getItem('theme') === 'light';

function updateTheme() {
  if (isLight) {
    body.classList.add('light-mode');
    if (themeBtn) themeBtn.textContent = '☀️';
  } else {
    body.classList.remove('light-mode');
    if (themeBtn) themeBtn.textContent = '🌙';
  }
}

if (themeBtn) {
  themeBtn.addEventListener('click', () => {
    isLight = !isLight;
    localStorage.setItem('theme', isLight ? 'light' : 'dark');
    updateTheme();
  });
}
// Init Theme
updateTheme();

// =========================================
//  TYPEWRITER EFFECT
// =========================================


// =========================================
//  AOS INIT
// =========================================
if (typeof AOS !== 'undefined') {
  AOS.init({
    duration: 800,
    once: true,
    offset: 50
  });
}

// =========================================
//  PROJECTS RENDERING & FILTERING
// =========================================
function renderProjects() {
  // 1. Render School Projects (activites.html)
  const schoolContainer = document.getElementById('projectsSchool');
  const personalContainer = document.getElementById('projectsPersonal');

  // 2. Render Latest Projects (index.html)
  const latestContainer = document.getElementById('projectsLatest');

  if (!schoolContainer && !personalContainer && !latestContainer) return;

  // Clear content before re-rendering
  if (schoolContainer) schoolContainer.innerHTML = '';
  if (personalContainer) personalContainer.innerHTML = '';
  if (latestContainer) latestContainer.innerHTML = '';

  const query = (document.getElementById('projectSearch')?.value || '').toLowerCase();

  // Get active tags from DOM (multi-select)
  const activeBtns = Array.from(document.querySelectorAll('.tag-filter.is-on'));
  const activeTags = activeBtns.map(btn => btn.getAttribute('data-tag'));

  // Default to 'all' if nothing selected or 'all' is explicitly selected
  const isAll = activeTags.length === 0 || activeTags.includes('all');

  let visibleCount = 0;
  let schoolCount = 0;
  let personalCount = 0;

  // Helper to create card
  const createCard = (project) => {
    const card = document.createElement('article');
    card.className = 'project-card aos-animate';
    card.setAttribute('data-aos', 'fade-up');

    const titleText = (project.titleKey && translations[currentLang][project.titleKey]) || project.title;

    let imgHTML = '';
    if (project.img) imgHTML = `<img loading="lazy" src="${project.img}" alt="${titleText}" />`;

    let titleHTML = '';
    if (project.titleKey) {
      titleHTML = `<h3 data-i18n="${project.titleKey}">${translations[currentLang][project.titleKey]}</h3>`;
    } else {
      titleHTML = `<h3>${project.title}</h3>`;
    }

    let detailsHTML = '';
    if (project.goalKey) {
      detailsHTML += `<p><strong data-i18n="projects.goal_label">${translations[currentLang]['projects.goal_label']}</strong> <span data-i18n="${project.goalKey}">${translations[currentLang][project.goalKey]}</span></p>`;
    } else if (project.goal) {
      detailsHTML += `<p><strong>Objectif :</strong> ${project.goal}</p>`;
    }

    // Environment or Material
    if (project.envKey && project.envText) {
      detailsHTML += `<p><strong data-i18n="${project.envKey}">${translations[currentLang][project.envKey]}</strong> ${project.envText}</p>`;
    } else if (project.matKey && project.matText) {
      detailsHTML += `<p><strong data-i18n="${project.matKey}">${translations[currentLang][project.matKey]}</strong> ${project.matText}</p>`;
    } else if (project.content) {
      detailsHTML += `<p><strong>Contenu :</strong> ${project.content}</p>`;
    }

    // List
    let listHTML = '';
    if (project.listKeys) {
      listHTML += '<ul>';
      project.listKeys.forEach(k => {
        listHTML += `<li data-i18n="${k}">${translations[currentLang][k]}</li>`;
      });
      listHTML += '</ul>';
    } else if (project.listRaw) {
      listHTML += '<ul>';
      project.listRaw.forEach(item => listHTML += `<li>${item}</li>`);
      listHTML += '</ul>';
    }

    // Result
    let resultHTML = '';
    if (project.resultKey) {
      resultHTML += `<p><strong data-i18n="${project.resultKey}">${translations[currentLang][project.resultKey]}</strong> <span data-i18n="${project.resultTextKey}">${translations[currentLang][project.resultTextKey]}</span></p>`;
    }

    // Actions
    let actionsHTML = '';
    if (project.detailLink) {
      actionsHTML += `<a href="${project.detailLink}" class="btn" style="text-decoration:none; text-align:center;" data-i18n="projects.btn_detail">${translations[currentLang]['projects.btn_detail']}</a>`;
    }
    if (project.pdfLink) {
      actionsHTML += `<a class="btn" href="${project.pdfLink}" download style="text-decoration:none; text-align:center; margin-top:0.5rem;" data-i18n="projects.btn_pdf">${translations[currentLang]['projects.btn_pdf']}</a>`;
    }
    if (project.siteLink) {
      actionsHTML += `<a class="btn" href="${project.siteLink}" target="_blank" rel="noopener" style="text-decoration:none; text-align:center; margin-top:0.5rem;" data-i18n="projects.restaurant.btn_site">${translations[currentLang]['projects.restaurant.btn_site'] || '🌐 Site'}</a>`;
    }

    card.innerHTML = `
            ${imgHTML}
            ${titleHTML}
            ${detailsHTML}
            ${listHTML}
            ${resultHTML}
            <div class="actions" style="display:flex; flex-direction:column; align-items:stretch; gap:0.5rem; margin: 1rem 1rem 0;">
                ${actionsHTML}
            </div>
        `;
    return card;
  };

  if (typeof PROJECTS !== 'undefined') {
    // Decide which projects to show on Home (Latest)
    // For now, let's just pick the first 3
    const latestProjects = PROJECTS.slice(0, 3);

    if (latestContainer) {
      latestProjects.forEach(project => {
        const card = createCard(project);
        latestContainer.appendChild(card);
      });
    }

    // Logic for Activites page
    PROJECTS.forEach(project => {
      if (schoolContainer || personalContainer) {
        const tags = project.tags || [];
        // Multi-tag Logic: OR logic (inclusive)
        const matchesTag = isAll || activeTags.some(t => tags.includes(t));

        // Search
        const titleText = (project.titleKey && translations[currentLang][project.titleKey]) || project.title || '';
        const searchable = (titleText + ' ' + (project.id || '') + ' ' + tags.join(' ')).toLowerCase();
        const matchesSearch = searchable.includes(query);

        if (matchesTag && matchesSearch) {
          visibleCount++;
          const card = createCard(project);

          if (project.type === 'school' && schoolContainer) {
            schoolContainer.appendChild(card);
            schoolCount++;
          } else if (project.type === 'personal' && personalContainer) {
            personalContainer.appendChild(card);
            personalCount++;
          }
        }
      }
    });
  }

  // Update Titles Visibility on Activites Page
  const tSchool = document.querySelector('[data-i18n="projects.school_title"]');
  const tPerso = document.querySelector('[data-i18n="projects.personal_title"]');
  if (tSchool) tSchool.style.display = schoolCount > 0 ? 'block' : 'none';
  if (tPerso) tPerso.style.display = personalCount > 0 ? 'block' : 'none';

  // No Results
  const noResults = document.getElementById('noResults');
  if (noResults) {
    if (visibleCount === 0) {
      noResults.style.display = 'block';
      noResults.innerHTML = `
        <div style="text-align:center; padding: 3rem 1rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">🔍</div>
          <p style="font-size:1.1rem; color:var(--text-primary); margin-bottom:0.5rem;" data-i18n="projects.no_results_title">Aucun projet trouvé</p>
          <p style="color:var(--text-secondary); font-size:0.9rem;" data-i18n="projects.no_results_desc">Essayez de modifier votre recherche ou les filtres.</p>
          <button class="btn" style="margin-top:1rem;" onclick="document.querySelectorAll('.tag-filter').forEach(b => b.classList.remove('is-on')); renderProjects();">Réinitialiser</button>
        </div>
      `;
    } else {
      noResults.style.display = 'none';
    }
  }

  // Count
  const countSpan = document.getElementById('searchCount');
  if (countSpan) countSpan.textContent = `(${visibleCount})`;

  if (typeof initTiltEffect === 'function') initTiltEffect();
  if (typeof initSpotlight === 'function') initSpotlight();
}

// =========================================
//  SPOTLIGHT EFFECT (Premium)
// =========================================
function initSpotlight() {
  const cards = document.querySelectorAll('.project-card, .skill-card, .article-card, .tech-card');
  cards.forEach(card => {
    card.addEventListener('mousemove', (e) => {
      const rect = card.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      card.style.setProperty('--mouse-x', `${x}px`);
      card.style.setProperty('--mouse-y', `${y}px`);
    });
  });
}

// Call initSpotlight on load and after renderProjects
document.addEventListener('DOMContentLoaded', initSpotlight);
// We also need to call it inside renderProjects (already handled by calling initTiltEffect? No, separate)
// Let's hook into existing logic or just observer.

// Event Listeners for Filters
const projectSearch = document.getElementById('projectSearch');
if (projectSearch) {
  projectSearch.addEventListener('input', renderProjects);
}

document.querySelectorAll('.tag-filter').forEach(btn => {
  btn.addEventListener('click', () => {
    const tag = btn.getAttribute('data-tag');

    if (tag === 'all') {
      // If "All" clicked, clear others, select All
      document.querySelectorAll('.tag-filter').forEach(b => b.classList.remove('is-on'));
      btn.classList.add('is-on');
    } else {
      // If specific tag clicked
      const allBtn = document.querySelector('.tag-filter[data-tag="all"]');
      if (allBtn) allBtn.classList.remove('is-on'); // Deselect "All"

      btn.classList.toggle('is-on'); // Toggle state

      // If no tags left, re-select "All" (Optional UX, but good for "reset")
      const anyActive = document.querySelectorAll('.tag-filter.is-on').length > 0;
      if (!anyActive && allBtn) {
        allBtn.classList.add('is-on');
      }
    }

    renderProjects();
  });
});


// =========================================
//  CONTACT FORM (EMAILJS)
// =========================================
// Initialize EmailJS
(function () {
  // PUBLIC KEY
  emailjs.init("B33KUw_SRxXz54Mng");
})();

// =========================================
//  TOAST NOTIFICATIONS (Global)
// =========================================
function showToast(message, type = 'info') {
  let container = document.getElementById('toast-container');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'toast-container';
    document.body.appendChild(container);
  }

  const toast = document.createElement('div');
  toast.className = `toast ${type}`;

  let icon = 'ℹ️';
  if (type === 'success') icon = '✅';
  if (type === 'error') icon = '❌';

  toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;

  container.appendChild(toast);

  // Auto remove
  setTimeout(() => {
    toast.style.animation = 'slideOutToast 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards';
    toast.addEventListener('animationend', () => {
      toast.remove();
      if (container.children.length === 0) container.remove();
    });
  }, 4000);
}

// =========================================
//  EMAILJS INTEGRATION
// =========================================
const contactForm = document.getElementById('contactForm');
if (contactForm) {
  contactForm.addEventListener('submit', function (event) {
    event.preventDefault();

    const btn = document.getElementById('sendBtn');
    const status = document.getElementById('formStatus');

    btn.textContent = 'Envoi...';
    btn.disabled = true;

    // Send params (Standard EmailJS names)
    const templateParams = {
      from_name: contactForm.querySelector('[name="user_name"]').value,
      reply_to: contactForm.querySelector('[name="user_email"]').value,
      message: contactForm.querySelector('[name="message"]').value
    };

    emailjs.send('service_irwg4qn', 'template_h2a018w', templateParams)
      .then(() => {
        showToast('Message envoyé avec succès !', 'success');
        contactForm.reset();
        setTimeout(() => {
          const modal = document.getElementById('contactModal');
          if (modal) modal.close();
          if (status) status.textContent = "";
        }, 1000);
      }, (error) => {
        console.error('FAILED...', error);
        showToast("Erreur lors de l'envoi du message.", 'error');
        if (status) {
          status.textContent = "❌ Erreur technique. Contactez-moi par LinkedIn.";
          status.style.color = "red";
        }
      })
      .finally(() => {
        btn.textContent = 'Envoyer';
        btn.disabled = false;
      });
  });
}

// =========================================
//  MODALS (CONTACT)
// =========================================
const contactModal = document.getElementById('contactModal');
const openContactData = document.querySelectorAll('[data-i18n="nav.contact"]'); // Links with text
// Also handle the footer email button if needed, or specific buttons
// Let's attach to any <a> that is href="mailto:..." but we want to intercept
// Actually, specifically for the header button:
const headerContactBtn = document.querySelector('.header-contact .btn');

if (contactModal && headerContactBtn) {
  headerContactBtn.addEventListener('click', (e) => {
    e.preventDefault();
    contactModal.showModal();
  });
}

// Mobile FAB Listener
const mobileContactBtn = document.getElementById('mobileContactBtn');
if (contactModal && mobileContactBtn) {
  mobileContactBtn.addEventListener('click', (e) => {
    e.preventDefault();
    contactModal.showModal();
  });
}
const closeContactBtn = document.getElementById('closeContact');
if (closeContactBtn && contactModal) {
  closeContactBtn.addEventListener('click', () => {
    contactModal.close();
  });
}
// CLICK OUTSIDE
if (contactModal) {
  contactModal.addEventListener('click', (e) => {
    const rect = contactModal.getBoundingClientRect();
    const isInDialog = (rect.top <= e.clientY && e.clientY <= rect.top + rect.height
      && rect.left <= e.clientX && e.clientX <= rect.left + rect.width);
    if (!isInDialog) {
      contactModal.close();
    }
  });
}


// =========================================
//  FADE IN UP INTERSECTION OBSERVER
// =========================================
const observerOptions = {
  root: null,
  rootMargin: '0px',
  threshold: 0.1
};

const observer = new IntersectionObserver((entries, observer) => {
  entries.forEach(entry => {
    if (entry.isIntersecting) {
      entry.target.classList.add('in-view');
      observer.unobserve(entry.target);
    }
  });
}, observerOptions);

document.querySelectorAll('.fade-in-up').forEach(el => {
  observer.observe(el);
});

// =========================================
//  SCROLL TO TOP BUTTON
// =========================================
const scrollTopBtn = document.getElementById('scrollTop');
const headerInner = document.querySelector('.header-inner');

// Optimized Scroll Listener
let isScrolling = false;
window.addEventListener('scroll', () => {
  if (!isScrolling) {
    window.requestAnimationFrame(() => {
      updateScrollUI();
      isScrolling = false;
    });
    isScrolling = true;
  }
});

function updateScrollUI() {
  // 1. Scroll Button Visibility
  if (window.scrollY > 300) {
    scrollTopBtn?.classList.add('show');

    // 2. Move Theme Button to Header Inner (Right of Contact)
    if (themeBtn && headerInner && !headerInner.contains(themeBtn)) {
      headerInner.appendChild(themeBtn);
      themeBtn.classList.add('in-menu');
    }
  } else {
    scrollTopBtn?.classList.remove('show');

    // 3. Move Theme Button back to Body (or original spot)
    if (themeBtn && headerInner && headerInner.contains(themeBtn)) {
      document.body.appendChild(themeBtn);
      themeBtn.classList.remove('in-menu');
    }
  }
}

// 3D TILT LOGIC (Performance Optimized)
function initTiltEffect() {
  const cards = document.querySelectorAll('.project-card');

  cards.forEach(card => {
    // Clean up old listeners if any (optional, but good practice)
    // For simplicity, we assume re-render replaces DOM nodes so usually fine.

    card.addEventListener('mouseenter', () => {
      card.style.setProperty('transition', 'none', 'important');
      card.style.zIndex = '10';
    });

    let ticking = false;
    card.addEventListener('mousemove', (e) => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          const rect = card.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          const rotateX = ((y - centerY) / centerY) * -5;
          const rotateY = ((x - centerX) / centerX) * 5;

          card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;

          ticking = false;
        });
        ticking = true;
      }
    });



    card.addEventListener('mouseleave', () => {
      card.style.transition = 'transform 0.5s ease';
      card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
      card.style.zIndex = '1';
    });
  });
}

if (scrollTopBtn) {
  scrollTopBtn.addEventListener('click', () => {
    window.scrollTo({
      top: 0,
      behavior: 'smooth'
    });
  });
}


// =========================================
//  INSTANT PAGE LOAD (PREFETCH ON HOVER)
// =========================================
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('a').forEach(link => {
    if (link.href.includes(window.location.hostname)) { // Internal links only
      link.addEventListener('mouseenter', () => {
        try {
          const url = new URL(link.href).href; // Normalize
          if (!document.querySelector(`link[rel="prefetch"][href="${url}"]`)) {
            const prefetchLink = document.createElement('link');
            prefetchLink.rel = 'prefetch';
            prefetchLink.href = url;
            document.head.appendChild(prefetchLink);
          }
        } catch (e) { }
      });
    }
  });
});

// =========================================
//  ADMIN CONSOLE (Easter Egg)
// =========================================
function initConsole() {
  // --- VIRTUAL FILE SYSTEM ---
  const vfs = {
    '/': {
      type: 'dir',
      children: {
        'home': {
          type: 'dir',
          children: {
            'brieuc': {
              type: 'dir',
              children: {
                'cv.pdf': { type: 'file', content: '[BINARY DATA] Use "cv" command to download.' },
                'todo.txt': { type: 'file', content: '- Finish Portfolio\n- Learn Kubernetes\n- Sleep (optional)' },
                'projects': {
                  type: 'dir',
                  children: {
                    'portfolio': { type: 'dir', children: {} },
                    'homelab.md': { type: 'file', content: '# My Homelab\nRaspberry Pi 4 (Pi-hole, VPN)\nNAS Synology (Plex)' }
                  }
                },
                'secrets': {
                  type: 'dir',
                  children: {
                    'password.txt': { type: 'file', content: 'admin:admin (Do not share!)' }
                  }
                }
              }
            },
            'guest': { type: 'dir', children: {} }
          }
        },
        'var': { type: 'dir', children: { 'www': { type: 'dir', children: {} } } },
        'etc': { type: 'dir', children: { 'hosts': { type: 'file', content: '127.0.0.1 localhost' } } },
        'bin': { type: 'dir', children: {} }
      }
    }
  };

  let currentPath = ['/', 'home', 'brieuc'];
  let commandHistory = [];
  let historyIndex = -1;
  let currentUser = 'admin';

  // Helper: Get node from path
  const resolvePath = (pathArr) => {
    let current = vfs['/'];
    if (pathArr.length === 1 && pathArr[0] === '/') return current;

    // Start from 1 because 0 is root
    for (let i = 1; i < pathArr.length; i++) {
      if (current.children && current.children[pathArr[i]]) {
        current = current.children[pathArr[i]];
      } else {
        return null;
      }
    }
    return current;
  };

  // Helper: Format Path string
  const getPathString = () => {
    if (currentPath.length === 1) return '/';
    return '/' + currentPath.slice(1).join('/');
  };

  // 1. Inject HTML
  const consoleHTML = `
    <div id="consoleTrigger" class="console-trigger" title="Open Admin Console">>_</div>
    <div id="consoleOverlay" class="console-overlay">
      <div class="console-window">
        <div class="console-header">
          <span>admin@brieuc-portfolio:~</span>
          <button id="closeConsole" style="background:none;border:none;color:#888;cursor:pointer;">[x]</button>
        </div>
        <div class="console-body" id="consoleBody">
          <div class="console-output">
            <div>Welcome to BrieucOS v1.0.0 LTS</div>
            <div>Type <span class="info">'help'</span> to see available commands.</div>
            <br>
          </div>
          <div class="console-input-line">
            <span class="console-prompt" id="promptPath">admin@brieuc:~/home/brieuc$</span>
            <input type="text" id="consoleInput" class="console-input" autocomplete="off" spellcheck="false">
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', consoleHTML);

  // 2. DOM Elements
  const trigger = document.getElementById('consoleTrigger');
  const overlay = document.getElementById('consoleOverlay');
  const closeBtn = document.getElementById('closeConsole');
  const input = document.getElementById('consoleInput');
  const output = document.querySelector('.console-output');
  const body = document.getElementById('consoleBody');
  const promptSpan = document.getElementById('promptPath');

  // Update Prompt
  const updatePrompt = () => {
    let displayPath = getPathString();
    if (displayPath.startsWith('/home/brieuc')) {
      displayPath = displayPath.replace('/home/brieuc', '~');
    }
    promptSpan.textContent = `admin@brieuc:${displayPath}$`;
  };
  updatePrompt();

  // 3. Functions
  const print = (text, type = '') => {
    const div = document.createElement('div');
    if (type) div.className = type;
    div.innerHTML = text;
    output.appendChild(div);
    body.scrollTop = body.scrollHeight;
  };

  const triggerBSOD = () => {
    print('WARNING: DESTRUCTIVE COMMAND DETECTED.', 'error');
    setTimeout(() => print('Deleting /var/www/html...', 'error'), 500);
    setTimeout(() => print('Deleting /home/brieuc...', 'error'), 1000);
    setTimeout(() => print('Deleting /etc/hosts...', 'error'), 1500);
    setTimeout(() => print('KERNEL PANIC: INIT KILLED.', 'error'), 2000);
    setTimeout(() => {
      document.body.innerHTML = '<div style="background:#0078D7;color:white;height:100vh;display:flex;align-items:center;justify-content:center;font-family:Segoe UI, sans-serif;font-size:2rem;flex-direction:column;text-align:center;">' +
        '<div style="font-size:8rem;margin-bottom:20px;">:(</div>' +
        '<div style="font-size:1.5rem;max-width:800px;">Your PC ran into a problem and needs to restart. We\'re just collecting some error info, and then we\'ll restart for you.</div>' +
        '<div style="font-size:1rem;margin-top:40px;">0% complete</div>' +
        '</div>';
    }, 3000);
    setTimeout(() => location.reload(), 7000);
  };

  // Helper: Matrix Rain
  let matrixInterval;
  const initMatrix = () => {
    // Remove existing if any
    const old = document.querySelector('.matrix-canvas');
    if (old) old.remove();

    const canvas = document.createElement('canvas');
    canvas.className = 'matrix-canvas';
    canvas.width = document.getElementById('consoleBody').offsetWidth;
    canvas.height = document.getElementById('consoleBody').offsetHeight;
    document.getElementById('consoleBody').prepend(canvas);

    const ctx = canvas.getContext('2d');
    const cols = Math.floor(canvas.width / 20);
    const ypos = Array(cols).fill(0);

    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (matrixInterval) clearInterval(matrixInterval);
    matrixInterval = setInterval(() => {
      ctx.fillStyle = '#0001';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = '#0f0';
      ctx.font = '15pt monospace';

      ypos.forEach((y, i) => {
        const text = String.fromCharCode(Math.random() * 128);
        const x = i * 20;
        ctx.fillText(text, x, y);
        if (y > 100 + Math.random() * 10000) ypos[i] = 0;
        else ypos[i] = y + 20;
      });
    }, 50);
  };

  const virtualFiles = {
    'about.txt': 'Portfolio initialized. User: Brieuc. Role: Developer.',
    'projects.md': '# My Projects\n1. Portfolio (You are here)\n2. E-commerce Platform\n3. AI Chatbot',
    'contact.json': '{\n  "email": "contact@brieuc.fr",\n  "linkedin": "linkedin.com/in/brieuc"\n}',
    'secrets.log': 'ACCESS DENIED. Encrypted.',
    'skills.yml': '- React\n- Node.js\n- TypeScript\n- Python'
  };

  // Phase 7 State
  const startTime = Date.now();
  let todoList = [];
  let aliases = {};

  // --- DATA ---
  const helpMap = {
    '--- 🔍 NAVIGATION & DISCOVERY ---': [
      ['cd <dir>', 'Change directory'],
      ['ls', 'List directory'],
      ['projects', 'View projects'],
      ['pwd', 'Print working dir'],
      ['social', 'Social links']
    ],
    '--- ℹ️ INFORMATION & IDENTITY ---': [
      ['credits', 'View credits'],
      ['cv', 'Download CV'],
      ['date', 'Show date'],
      ['email', 'Show email'],
      ['neofetch', 'System info'],
      ['stats', 'Session metrics'],
      ['sysinfo', 'Browser details'],
      ['uptime', 'Session duration'],
      ['weather', 'Temperature'],
      ['whoami', 'User info'],
      ['whois', 'Domain info']
    ],
    '--- 💪 UTILITIES & TOOLS ---': [
      ['alias <k>=<v>', 'Set alias'],
      ['calc', 'Calculator'],
      ['contact', 'Send message'],
      ['currency', 'Convert money'],
      ['history', 'Command history'],
      ['man <cmd>', 'Manual pages'],
      ['password <len>', 'Gen password'],
      ['pomodoro', 'Start timer'],
      ['todo <act>', 'Task manager']
    ],
    '--- ⚙️ SYSTEM CONTROL ---': [
      ['clear', 'Clear screen'],
      ['echo <txt>', 'Print text'],
      ['exit', 'Close session'],
      ['ping', 'Test latency'],
      ['reboot', 'Reboot system'],
      ['shutdown', 'Power off'],
      ['sudo su', 'Root access'],
      ['theme', 'Color theme'],
      ['top', 'Process monitor']
    ],
    '--- 🎮 ENTERTAINMENT & FUN ---': [
      ['banner', 'Show logo'],
      ['game', 'Guess Number'],
      ['gui', 'Graphical UI'],
      ['hack', 'Simulate Hack'],
      ['invaders', 'Space Invaders'],
      ['matrix', 'Matrix Rain'],
      ['snake', 'Snake Game']
    ],
    '--- 🎲 RANDOM & TRIVIA ---': [
      ['coffee', 'Brew coffee'],
      ['cowsay', 'Talking cow'],
      ['fact', 'Random Fact'],
      ['flip', 'Flip coin'],
      ['fortune', 'Quote'],
      ['joke', 'Random Joke'],
      ['roll <side>', 'Roll dice']
    ]
  };

  const manuals = {
    'alias': 'Define or display aliases. Usage: alias <name>=<cmd>',
    'banner': 'Display the system logo.',
    'calc': 'Evaluate mathematical expressions. Usage: calc <expr>',
    'cat': 'Concatenate and display file content. Usage: cat <file>',
    'cd': 'Change the current directory. Usage: cd <dir>',
    'clear': 'Clear the terminal screen.',
    'coffee': 'Brew a fresh cup of coffee. Usage: coffee',
    'contact': 'Display contact information form.',
    'cowsay': 'Display a message spoken by a cow. Usage: cowsay <text>',
    'credits': 'Show project credits and author info.',
    'currency': 'Convert currency. Usage: currency <amt> <from> <to>',
    'cv': 'Download the curriculum vitae (PDF).',
    'date': 'Display the current system date and time.',
    'echo': 'Display a line of text. Usage: echo <text>',
    'email': 'Display the author\'s email address.',
    'exit': 'Close the terminal session.',
    'fact': 'Display a random interesting fact.',
    'flip': 'Flip a coin (Heads/Tails).',
    'fortune': 'Display a random quote or fortune.',
    'game': 'Play a number guessing game.',
    'gui': 'Attempt to launch the Graphical User Interface.',
    'help': 'Display information about builtin commands.',
    'history': 'Display the command history list.',
    'invaders': 'Play the Space Invaders game.',
    'joke': 'Tell a programming joke.',
    'ls': 'List directory contents.',
    'man': 'Format and display the on-line manual pages.',
    'matrix': 'Toggle the Matrix digital rain visual effect.',
    'neofetch': 'Display system information.',
    'password': 'Generate a secure password. Usage: password <len>',
    'ping': 'Send ICMP ECHO_REQUEST to network hosts. Usage: ping <url>',
    'pomodoro': 'Start a 25-minute Pomodoro timer.',
    'projects': 'Navigate to the projects page.',
    'pwd': 'Print name of current/working directory.',
    'reboot': 'Restart the system.',
    'roll': 'Roll a die. Usage: roll <sides>',
    'shutdown': 'Bring the system down.',
    'snake': 'Play the Snake game.',
    'social': 'Display social media links.',
    'stats': 'Display session statistics.',
    'sudo': 'Execute a command as another user.',
    'sysinfo': 'Display detailed browser and system info.',
    'theme': 'Set the color theme. Usage: theme <name>',
    'todo': 'Manage tasks. Usage: todo <add|list|del>',
    'top': 'Display processes (mock).',
    'uptime': 'Tell how long the system has been running.',
    'weather': 'Display current weather conditions (mock).',
    'whoami': 'Print effective userid.',
    'whois': 'Query a domain name database.'
  };

  // --- GAMES & HELPERS ---
  const startSnake = () => {
    print('Starting Snake... (Arrow Keys)', 'success');
    const sCanvas = document.createElement('canvas');
    sCanvas.width = 300;
    sCanvas.height = 300;
    sCanvas.style.border = '2px solid #0f0';
    sCanvas.style.marginTop = '10px';
    sCanvas.style.background = '#000';
    output.appendChild(sCanvas);
    body.scrollTop = body.scrollHeight;
    const sCtx = sCanvas.getContext('2d');
    let snake = [{ x: 10, y: 10 }];
    let food = { x: 15, y: 15 };
    let dx = 0; let dy = 0; let score = 0;
    const tile = 15;
    const tileCount = sCanvas.width / tile;
    const drawSnake = () => {
      sCtx.fillStyle = '#000'; sCtx.fillRect(0, 0, 300, 300);
      sCtx.fillStyle = '#f00'; sCtx.fillRect(food.x * tile, food.y * tile, tile - 2, tile - 2);
      sCtx.fillStyle = '#0f0'; snake.forEach(p => sCtx.fillRect(p.x * tile, p.y * tile, tile - 2, tile - 2));
      const head = { x: snake[0].x + dx, y: snake[0].y + dy };
      snake.unshift(head);
      if (head.x === food.x && head.y === food.y) {
        score++; food = { x: Math.floor(Math.random() * tileCount), y: Math.floor(Math.random() * tileCount) };
      } else snake.pop();
      if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
        clearInterval(gameInterval); print(`Game Over.Score: ${score} `, 'error'); sCanvas.remove();
      }
    };
    const keyDownEvent = (e) => {
      if (e.key === 'ArrowLeft' && dx !== 1) { dx = -1; dy = 0; } if (e.key === 'ArrowUp' && dy !== 1) { dx = 0; dy = -1; }
      if (e.key === 'ArrowRight' && dx !== -1) { dx = 1; dy = 0; } if (e.key === 'ArrowDown' && dy !== -1) { dx = 0; dy = 1; }
    };
    document.addEventListener('keydown', keyDownEvent);
    const gameInterval = setInterval(drawSnake, 100);
    const stopGame = () => { clearInterval(gameInterval); document.removeEventListener('keydown', keyDownEvent); };
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') stopGame(); }, { once: true });
  };

  const startInvaders = () => {
    print('Space Invaders launched.', 'success');
    const iCanvas = document.createElement('canvas');
    iCanvas.width = 300; iCanvas.height = 300;
    iCanvas.style.border = '2px solid #0f0'; iCanvas.style.background = '#000';
    output.appendChild(iCanvas);
    const iCtx = iCanvas.getContext('2d');
    let iScore = 0;
    let player = { x: 135, y: 270, w: 30, h: 10 };
    let bullets = [];
    let enemies = [];
    for (let r = 0; r < 3; r++) { for (let c = 0; c < 6; c++) enemies.push({ x: 30 + c * 40, y: 30 + r * 30, w: 20, h: 20, alive: true }); }
    let dx = 2; // Enemy speed
    const drawInvaders = () => {
      iCtx.fillStyle = '#000'; iCtx.fillRect(0, 0, 300, 300);
      // Player (Retro Ship)
      iCtx.fillStyle = '#0f0';
      iCtx.fillRect(player.x + 10, player.y, 10, 5); // Top
      iCtx.fillRect(player.x, player.y + 5, 30, 5);  // Bottom
      // Bullets
      iCtx.fillStyle = '#fff';
      bullets.forEach((b, i) => {
        b.y -= 5;
        iCtx.fillRect(b.x, b.y, 2, 8);
        if (b.y < 0) bullets.splice(i, 1)
      });
      // Enemies (Invader Sprite)
      let edge = false;
      iCtx.fillStyle = '#f00';
      enemies.forEach(e => {
        if (e.alive) {
          iCtx.fillRect(e.x + 5, e.y, 10, 5);
          iCtx.fillRect(e.x, e.y + 5, 20, 10);
          iCtx.fillRect(e.x, e.y + 15, 5, 5);
          iCtx.fillRect(e.x + 15, e.y + 15, 5, 5);
          // Collision
          bullets.forEach((b, bi) => {
            if (b.x > e.x && b.x < e.x + e.w && b.y > e.y && b.y < e.y + e.h) {
              e.alive = false;
              bullets.splice(bi, 1);
              iScore += 10;
            }
          });
          e.x += dx;
          if (e.x + e.w > 300 || e.x < 0) edge = true;
        }
      });
      if (edge) {
        dx = -dx;
        enemies.forEach(e => e.y += 10);
      }
      // HUD
      iCtx.fillStyle = '#fff';
      iCtx.font = '10px monospace';
      iCtx.fillText('SCORE: ' + iScore, 10, 15);
    };
    const iKeyEvents = (e) => {
      if (e.key === 'ArrowLeft' && player.x > 0) player.x -= 15;
      if (e.key === 'ArrowRight' && player.x < 270) player.x += 15;
      if (e.key === ' ') bullets.push({ x: player.x + 13, y: player.y - 10 });
    };
    document.addEventListener('keydown', iKeyEvents);
    const invInt = setInterval(drawInvaders, 50);
    const stopInv = () => { clearInterval(invInt); document.removeEventListener('keydown', iKeyEvents); };
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') stopInv(); }, { once: true });
  };

  const startHack = () => {
    print('Initiating brute-force attack on NSA servers...', 'warn');
    let hCount = 0;
    const hInt = setInterval(() => {
      if (hCount > 20) {
        clearInterval(hInt);
        print('ACCESS DENIED. Connection terminated by host.', 'error');
      } else {
        print(`[${Math.random().toString(16).substr(2, 8)}] Uploading payload... ${hCount * 5}%`, 'info');
        const output = document.querySelector('.console-output');
        output.scrollTop = output.scrollHeight;
        hCount++;
      }
    }, 150);
  };

  const startPomodoro = () => {
    print('Starting 25-minute timer...', 'info');
    let pTime = 25 * 60;
    const pInt = setInterval(() => {
      pTime--;
      if (pTime <= 0) {
        clearInterval(pInt);
        print('Pomodoro complete! Take a break.', 'success');
        new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(() => { });
      } else if (pTime % 300 === 0) {
        print(`${pTime / 60} minutes remaining...`, 'info');
      }
    }, 1000);
  };

  // --- COMMAND REGISTRY ---
  const COMMANDS = {
    'pwd': () => print('/home/brieuc', 'info'),
    'ls': () => print(Object.keys(virtualFiles).join('   '), 'info'),
    'cd': () => print('Directory navigation restricted (demo mode).', 'warn'),
    'cat': (args) => {
      if (!args[1]) {
        print(' /\\_/\\ ', 'pre');
        print('( o.o )', 'pre');
        print(' > ^ < ', 'pre');
      } else {
        const fileName = args[1];
        if (virtualFiles[fileName]) {
          const content = virtualFiles[fileName].replace(/\n/g, '<br>');
          print(content, 'info');
        } else print('cat: ' + fileName + ': No such file or directory', 'error');
      }
    },
    'mkdir': () => print('Permission denied: Read-only file system.', 'error'),
    'help': () => {
      print('Available commands:', 'info');
      print('Type "banner" to see the logo.', 'success');
      // Calculate maxLen for padding
      let maxLen = 0;
      Object.values(helpMap).forEach(cmds => {
        cmds.forEach(([c]) => { if (c.length > maxLen) maxLen = c.length; });
      });
      maxLen += 2;
      for (const [section, commands] of Object.entries(helpMap)) {
        print(section, 'warn');
        commands.forEach(([cmd, desc]) => {
          let paddedCmd = cmd.padEnd(maxLen, ' ');
          paddedCmd = paddedCmd.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          print(`${paddedCmd} : ${desc}`);
        });
        print(' ');
      }
    },
    'whoami': () => {
      print('User: Brieuc Métairie', 'success');
      print('Role: Future SysAdmin & Network Expert');
      print('Location: France');
    },
    'social': () => {
      print('-----------------------------', 'info');
      print('LinkedIn: <a href="https://linkedin.com/in/brieuc-metairie" target="_blank" style="color:#00f">linkedin.com/in/brieuc-metairie</a>');
      print('GitHub:   <a href="https://github.com/brieuc-metairie" target="_blank" style="color:#00f">github.com/brieuc-metairie</a>');
      print('Email:    <a href="mailto:metairiebrieuc@gmail.com" style="color:#00f">metairiebrieuc@gmail.com</a>');
      print('-----------------------------', 'info');
    },
    'projects': () => {
      print('Redirecting to /activites.html...', 'warn');
      setTimeout(() => window.location.href = 'activites.html', 800);
    },
    'contact': () => {
      print('Opening secure channel...', 'warn');
      setTimeout(() => {
        overlay.classList.remove('open');
        const modal = document.getElementById('contactModal');
        if (modal) modal.showModal();
      }, 500);
    },
    'cv': () => {
      print('Downloading CV...', 'success');
      const link = document.createElement('a');
      link.href = 'assets/cv.pdf';
      link.download = 'CV_Brieuc_Metairie.pdf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    },
    'theme': (args) => {
      const mode = args[1];
      const consoleWin = document.querySelector('.console-window');
      if (mode === 'retro') {
        consoleWin.classList.add('theme-retro');
        consoleWin.classList.remove('theme-ocean', 'theme-dracula');
        if (matrixInterval) { clearInterval(matrixInterval); document.querySelector('.matrix-canvas')?.remove(); }
        print('Theme set to RETRO.', 'success');
      } else if (mode === 'ocean') {
        consoleWin.classList.add('theme-ocean');
        consoleWin.classList.remove('theme-retro', 'theme-dracula');
        if (matrixInterval) { clearInterval(matrixInterval); document.querySelector('.matrix-canvas')?.remove(); }
        print('Theme set to OCEAN.', 'success');
      } else if (mode === 'dracula') {
        consoleWin.classList.add('theme-dracula');
        consoleWin.classList.remove('theme-retro', 'theme-ocean');
        if (matrixInterval) { clearInterval(matrixInterval); document.querySelector('.matrix-canvas')?.remove(); }
        print('Theme set to DRACULA.', 'success');
      } else if (mode === 'matrix' || mode === 'green') {
        consoleWin.classList.remove('theme-retro', 'theme-ocean', 'theme-dracula');
        initMatrix();
        print('Theme set to MATRIX (Visuals ON).', 'success');
      } else {
        print('Usage: theme <retro|ocean|dracula|matrix>', 'warn');
      }
    },
    'neofetch': (args) => {
      print('            .-/+oossssoo+/-.               brieuc@portfolio', 'pre');
      print('        `:+ssssssssssssssssss+:`           ----------------', 'pre');
      print('      -+ssssssssssssssssssyyssss+-         OS: PortfolioOS Web 1.0', 'pre');
      print('    .ossssssssssssssssssdMMMNysssso.       Host: Browser', 'pre');
      print('   /ssssssssssshdmmNNmmyNMMMMhssssss/      Uptime: Forever', 'pre');
      print('  +ssssssssshmydMMMMMMMNddddyssssssss+     Packages: 1 (npm)', 'pre');
      print(' /sssssssshNMMMyhhyyyyhmNMMMNhssssssss/    Shell: JS-Shell zsh', 'pre');
      print('.ssssssssdMMMNhsssssssssshNMMMdssssssss.   Resolution: ' + window.innerWidth + 'x' + window.innerHeight, 'pre');
      print('+sssshhhyNMMNyssssssssssssyNMMMysssssss+   Theme: ' + (args[2] || 'Retro'), 'pre');
      print('ossyNMMMNyMMhsssssssssssssshmmmhssssssso   CPU: 100% Brain', 'pre');
    },
    'cowsay': (args) => {
      const txt = args.slice(1).join(' ') || 'Moo!';
      const len = txt.length;
      const line = '-'.repeat(len + 2);
      print(' ' + line, 'pre');
      print('< ' + txt + ' >', 'pre');
      print(' ' + line, 'pre');
      print('        \\   ^__^', 'pre');
      print('         \\  (oo)\\_______', 'pre');
      print('            (__)\\       )\\/\\', 'pre');
      print('                ||----w |', 'pre');
      print('                ||     ||', 'pre');
    },
    'banner': () => {
      print(' ______       _                   ', 'pre');
      print('|  _  \\     (_)                  ', 'pre');
      print('| |_) |_ __  _  ___  _   _  ___  ', 'pre');
      print('|  _ <| \'__| |/ _ \\| | | |/ __| ', 'pre');
      print('| |_) | |   | |  __/| |_| | (__  ', 'pre');
      print('|____/|_|   |_|\\___| \\__,_|\\___| ', 'pre');
      print('          |__/                 ', 'pre');
    },
    'matrix': () => {
      initMatrix();
      print('Wake up, Neo...', 'success');
    },
    'shutdown': () => {
      print('System halting...', 'error');
      setTimeout(() => {
        let overlay = document.querySelector('.shutdown-overlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.className = 'shutdown-overlay';
          overlay.innerText = "SYSTEM HALTED";
          document.body.appendChild(overlay);
        }
        overlay.offsetHeight;
        overlay.classList.add('active');
      }, 1000);
    },
    'reboot': () => {
      print('Rebooting system...', 'warn');
      setTimeout(() => location.reload(), 1000);
    },
    'calc': (args) => {
      const expr = args.slice(1).join('');
      if (!expr) {
        print('Usage: calc <expression> (ex: 2+2)', 'warn');
      } else {
        try {
          if (/[^0-9+\-*/().]/.test(expr)) {
            print('Error: Invalid characters.', 'error');
          } else {
            const result = new Function('return ' + expr)();
            print(`${expr} = ${result}`, 'success');
          }
        } catch (e) {
          print('Error: Invalid expression.', 'error');
        }
      }
    },
    'vim': () => {
      print('You are trapped in a text editor.', 'error');
      print('Press ESC to exit...', 'info');
      setTimeout(() => print('Just kidding. Type :q! to quit.', 'info'), 1500);
    },
    'vi': () => COMMANDS['vim'](),
    ':q!': () => print('Phew! You escaped.', 'success'),
    ':q': () => COMMANDS[':q!'](),
    'sudo': (args) => {
      if (args[1] === 'rm' && args[2] === '-rf' && args[3] === '/') {
        triggerBSOD();
      } else if (args[1] === 'su' || args[1] === '-i') {
        print('Password for brieuc:', 'warn');
        setTimeout(() => {
          print('******', 'info');
          setTimeout(() => {
            print('Switched to user root', 'success');
            currentUser = 'root';
            document.getElementById('promptPath').innerText = 'root@brieuc:~#';
          }, 800);
        }, 1000);
      } else {
        print('Permission denied: You are not root.', 'error');
      }
    },
    'su': () => COMMANDS['sudo'](['sudo', 'su']),
    'rm': (args) => {
      if (currentUser === 'root' && args[1] === '-rf' && args[2] === '/') {
        triggerBSOD();
      } else if (currentUser !== 'root') {
        print('Permission denied: You are not root.', 'error');
      } else {
        print('Usage: rm -rf / (Do not try this)', 'warn');
      }
    },
    'history': () => print(commandHistory.map((c, i) => `${i + 1}  ${c}`).join('<br>'), 'info'),
    'ping': (args) => {
      const target = args[1] || 'google.com';
      print(`Pinging ${target} [142.250.178.14] with 32 bytes of data:`);
      let pings = 0;
      const pingInterval = setInterval(() => {
        if (pings >= 4) {
          clearInterval(pingInterval);
          print(`Ping statistics for ${target}:`, 'info');
          return;
        }
        const time = Math.floor(Math.random() * 20) + 10;
        print(`Reply from 142.250.178.14: bytes=32 time=${time}ms TTL=115`);
        pings++;
      }, 800);
    },
    'ipconfig': () => {
      print('Windows IP Configuration');
      print('IPv4 Address. . . . . . . . . . . : 192.168.1.42');
    },
    'date': () => print(new Date().toString()),
    'curl': (args) => {
      if (!args[1]) { print('curl: try \'curl <url>\'', 'warn'); }
      else {
        print(`Checking ${args[1]}...`, 'info');
        setTimeout(() => {
          print('&lt;html&gt;&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;', 'success');
        }, 400);
      }
    },
    'whois': (args) => {
      const domain = args[1] || 'brieuc-metairie.fr';
      print('Domain Name: ' + domain.toUpperCase());
      print('Registry Domain ID: 8675309');
      print('Registrar WHOIS Server: whois.google.com');
      print('Registrar URL: http://www.google.com');
      print('Registrar: Google LLC');
    },
    'top': () => {
      print('PID USER      PR  NI  VIRT  RES  SHR S  %CPU %MEM    TIME+ COMMAND', 'pre');
      print('  1 root      20   0  1.2g 123m  45m S   0.0  1.2   0:01.23 init', 'pre');
      print(' 42 brieuc    20   0  8.5g 4.2g 1.1g S  12.4 45.1  12:34.56 chrome', 'pre');
    },
    'htop': () => print('CPU[| 23%] MEM[|| 1.2G]'),
    'weather': () => {
      const cities = ['Server Room', 'Paris', 'Tokyo', 'New York', 'Mars Colony'];
      const temps = ['19°C', '12°C', '28°C', '-5°C', '-60°C'];
      const icons = ['🌡️', '☁️', '☀️', '❄️', '🚀'];
      const r = Math.floor(Math.random() * cities.length);
      setTimeout(() => {
        print(icons[r] + ' ' + cities[r] + ': ' + temps[r]);
      }, 500);
    },
    'snake': () => { if (typeof startSnake === 'function') startSnake(); },
    'invaders': () => { if (typeof startInvaders === 'function') startInvaders(); },
    'game': () => {
      print('Guess the number (0-100). Type "guess [number]".');
      window.targetNumber = Math.floor(Math.random() * 101);
    },
    'coffee': () => print('Here is your coffee! ☕', 'success'),
    'fortune': () => print('"It works on my machine."', 'success'),
    'hack': () => { if (typeof startHack === 'function') startHack(); },
    'roll': (args) => {
      const sides = parseInt(args[1]) || 6;
      print(`You rolled a ${Math.floor(Math.random() * sides) + 1} (d${sides})`, 'success');
    },
    'flip': () => print(Math.random() > 0.5 ? 'Heads' : 'Tails', 'success'),
    'fact': () => {
      const facts = [
        'The first computer bug was an actual moth.',
        'JavaScript was created in 10 days.',
        'The QWERTY layout was designed to slow you down.',
        '90% of the world\'s currency is digital.',
        'The first domain name ever registered was Symbolics.com.'
      ];
      print(facts[Math.floor(Math.random() * facts.length)], 'info');
    },
    'currency': (args) => {
      if (args.length < 4) {
        print('Usage: currency <amount> <from> <to> (e.g., 100 USD EUR)', 'warn');
      } else {
        const amt = parseFloat(args[1]);
        const from = args[2].toUpperCase();
        const to = args[3].toUpperCase();
        const rates = { 'USD': 1, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 150 };
        if (rates[from] && rates[to]) {
          const res = (amt / rates[from]) * rates[to];
          print(`${amt} ${from} = ${res.toFixed(2)} ${to}`, 'success');
        } else print('Unsupported currency. (Try USD, EUR, GBP, JPY)', 'error');
      }
    },
    'pomodoro': () => { if (typeof startPomodoro === 'function') startPomodoro(); },
    'password': (args) => {
      const len = parseInt(args[1]) || 12;
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
      let pwd = '';
      for (let i = 0; i < len; i++) pwd += chars.charAt(Math.floor(Math.random() * chars.length));
      print(`Generated Password: ${pwd}`, 'success');
    },
    'sysinfo': () => {
      print('Browser: ' + navigator.userAgent, 'info');
      print('Language: ' + navigator.language, 'info');
      print('Platform: ' + navigator.platform, 'info');
      print('Cores: ' + (navigator.hardwareConcurrency || 'Unknown'), 'info');
    },
    'gui': () => print('GUI? We don\'t do that here. CLI is life. 🐧', 'success'),
    'stats': () => {
      print('--- SESSION STATS ---', 'warn');
      print(`Commands Run: ${commandHistory.length}`, 'info');
      const uptimeS = Math.floor((Date.now() - startTime) / 1000);
      print(`Uptime: ${Math.floor(uptimeS / 60)}m ${uptimeS % 60}s`, 'info');
    },
    'alias': (args) => {
      if (!args[1]) {
        print('Current Aliases:', 'warn');
        Object.keys(aliases).forEach(k => print(`${k}=${aliases[k]}`, 'info'));
      } else {
        const pair = args.slice(1).join(' ').split('=');
        if (pair.length === 2) {
          aliases[pair[0].trim()] = pair[1].trim();
          print(`Alias set: ${pair[0]} -> ${pair[1]}`, 'success');
        } else print('Usage: alias <name>=<command>', 'warn');
      }
    },
    'joke': () => {
      const jokes = [
        'Why do programmers prefer dark mode? Because light attracts bugs.',
        'How many programmers does it take to change a light bulb? None, that\'s a hardware problem.',
        'I told my wife she was drawing her eyebrows too high. She looked surprised.',
        'There are 10 types of people in the world: those who understand binary, and those who don\'t.',
        'A SQL query walks into a bar, walks up to two tables and asks, "Can I join you?"'
      ];
      print(jokes[Math.floor(Math.random() * jokes.length)], 'success');
    },
    'todo': (args) => {
      const action = args[1];
      if (action === 'add') {
        const task = args.slice(2).join(' ');
        if (task) {
          todoList.push(task);
          print(`Task added: "${task}"`, 'success');
        } else print('Usage: todo add <task>', 'warn');
      } else if (action === 'list') {
        if (todoList.length === 0) print('No tasks yet.', 'info');
        else {
          print('TODO LIST:', 'warn');
          todoList.forEach((t, i) => print(`${i + 1}. ${t}`, 'info'));
        }
      } else if (action === 'del') {
        const idx = parseInt(args[2]) - 1;
        if (!isNaN(idx) && todoList[idx]) {
          print(`Deleted: "${todoList[idx]}"`, 'error');
          todoList.splice(idx, 1);
        } else print('Usage: todo del <number>', 'warn');
      } else {
        print('Usage: todo <add|list|del>', 'warn');
      }
    },
    'uptime': () => {
      const uptime = Math.floor((Date.now() - startTime) / 1000);
      const m = Math.floor(uptime / 60);
      const s = uptime % 60;
      print(`System up for ${m} minutes and ${s} seconds.`, 'info');
    },
    'man': (args) => {
      if (!args[1]) {
        print('What manual page do you want? (Usage: man <command>)', 'warn');
      } else {
        const cmdToFind = args[1];
        if (manuals[cmdToFind]) {
          print('NAME', 'pre');
          print(`    ${cmdToFind} - ${manuals[cmdToFind]}`, 'info');
        } else {
          print(`No manual entry for ${cmdToFind}`, 'error');
        }
      }
    },
    'email': () => print('metairiebrieuc@gmail.com', 'info'),
    'credits': () => {
      print('Portfolio created by Brieuc Métairie.', 'success');
      print('Built with HTML, CSS (Variables), and Vanilla JS.', 'info');
      print('Inspired by retro terminals and modern cyber-security UIs.', 'info');
    },
    'echo': (args) => print(args.slice(1).join(' '), 'info'),
    'clear': () => output.innerHTML = '',
    'exit': () => overlay.classList.remove('open')
  };

  const executeCommand = (command) => {
    const args = command.trim().split(' ');
    let cmd = args[0].toLowerCase();

    // Alias Resolution
    if (aliases[cmd]) {
      const expanded = aliases[cmd].split(' ');
      cmd = expanded[0];
      args.splice(0, 1, ...expanded);
    }

    // Command History
    if (commandHistory[commandHistory.length - 1] !== command && command.trim() !== '') {
      commandHistory.push(command);
    }
    const safeCmd = cmd.replace(/[<>]/g, '');
    if (safeCmd !== '') {
      const cmdLine = document.createElement('div');
      cmdLine.className = 'console-input-line';
      cmdLine.innerHTML = `<span class="console-prompt">${document.getElementById('promptPath').innerText}</span> <span style="color:#fff">${safeCmd} ${args.slice(1).join(' ')}</span>`;
      output.appendChild(cmdLine);
    }

    // Execution
    if (cmd === '') return;

    if (COMMANDS[cmd]) {
      COMMANDS[cmd](args);
    } else if (cmd.startsWith('guess ')) {
      const guess = parseInt(cmd.split(' ')[1]);
      if (isNaN(guess)) { print('Invalid number.', 'error'); return; }
      if (!window.targetNumber && window.targetNumber !== 0) { print('Start game first with "game".', 'error'); return; }
      if (guess === window.targetNumber) {
        print(`🎉 WIN! The number was ${window.targetNumber}.`, 'success'); window.targetNumber = null;
      } else if (guess < window.targetNumber) {
        print('Higher ↑', 'warn');
      } else {
        print('Lower ↓', 'warn');
      }
    } else {
      print(`Command not found: ${command} `, 'error');
    }
  };
  const args = command.trim().split(' ');
  let cmd = args[0].toLowerCase();

  // Alias Resolution
  if (aliases[cmd]) {
    const expanded = aliases[cmd].split(' ');
    cmd = expanded[0];
    args.splice(0, 1, ...expanded);
  }

  // 2. Command Logic
  if (commandHistory[commandHistory.length - 1] !== command && command.trim() !== '') {
    commandHistory.push(command);
  }
  const safeCmd = cmd.replace(/[<>]/g, '');
  // Echo command
  if (safeCmd !== '') {
    const cmdLine = document.createElement('div');
    cmdLine.className = 'console-input-line';
    cmdLine.innerHTML = `<span class="console-prompt">${document.getElementById('promptPath').innerText}</span> <span style="color:#fff">${safeCmd} ${args.slice(1).join(' ')}</span>`;
    output.appendChild(cmdLine);
  }
  switch (cmd) {
    // --- SHELL COMMANDS ---
    case 'pwd':
      print('/home/brieuc', 'info');
      break;
    case 'ls':
      print(Object.keys(virtualFiles).join('   '), 'info');
      break;
    case 'cd':
      print('Directory navigation restricted (demo mode).', 'warn');
      break;
    case 'cat':
      if (!args[1]) {
        print(' /\\_/\\ ', 'pre');
        print('( o.o )', 'pre');
        print(' > ^ < ', 'pre');
      } else {
        const fileName = args[1];
        if (virtualFiles[fileName]) {
          const content = virtualFiles[fileName].replace(/\n/g, '<br>');
          print(content, 'info');
        } else {
          print('cat: ' + fileName + ': No such file or directory', 'error');
        }
      }
      break;
    case 'mkdir':
      print('Permission denied: Read-only file system.', 'error');
      break;

    // --- GENERAL ---
    case 'help':
      print('Available commands:', 'info');
      print('Type "banner" to see the logo.', 'success');

      const helpMap = {
        '--- � NAVIGATION & DISCOVERY ---': [
          ['cd <dir>', 'Change directory'],
          ['ls', 'List directory'],
          ['projects', 'View projects'],
          ['pwd', 'Print working dir'],
          ['social', 'Social links']
        ],
        '--- ℹ️ INFORMATION & IDENTITY ---': [
          ['credits', 'View credits'],
          ['cv', 'Download CV'],
          ['date', 'Show date'],
          ['email', 'Show email'],
          ['neofetch', 'System info'],
          ['stats', 'Session metrics'],
          ['sysinfo', 'Browser details'],
          ['uptime', 'Session duration'],
          ['weather', 'Temperature'],
          ['whoami', 'User info'],
          ['whois', 'Domain info']
        ],
        '--- 💪 UTILITIES & TOOLS ---': [
          ['alias <k>=<v>', 'Set alias'],
          ['calc', 'Calculator'],
          ['contact', 'Send message'],
          ['currency', 'Convert money'],
          ['history', 'Command history'],
          ['man <cmd>', 'Manual pages'],
          ['password <len>', 'Gen password'],
          ['pomodoro', 'Start timer'],
          ['todo <act>', 'Task manager']
        ],
        '--- ⚙️ SYSTEM CONTROL ---': [
          ['clear', 'Clear screen'],
          ['echo <txt>', 'Print text'],
          ['exit', 'Close session'],
          ['ping', 'Test latency'],
          ['reboot', 'Reboot system'],
          ['shutdown', 'Power off'],
          ['sudo su', 'Root access'],
          ['theme', 'Color theme'],
          ['top', 'Process monitor']
        ],
        '--- 🎮 ENTERTAINMENT & FUN ---': [
          ['banner', 'Show logo'],
          ['game', 'Guess Number'],
          ['gui', 'Graphical UI'],
          ['hack', 'Simulate Hack'],
          ['invaders', 'Space Invaders'],
          ['matrix', 'Matrix Rain'],
          ['snake', 'Snake Game']
        ],
        '--- 🎲 RANDOM & TRIVIA ---': [
          ['coffee', 'Brew coffee'],
          ['cowsay', 'Talking cow'],
          ['fact', 'Random Fact'],
          ['flip', 'Flip coin'],
          ['fortune', 'Quote'],
          ['joke', 'Random Joke'],
          ['roll <side>', 'Roll dice']
        ]
      };

      // Calculate longest command for perfect padding
      let maxLen = 0;
      Object.values(helpMap).forEach(cmds => {
        cmds.forEach(([c]) => { if (c.length > maxLen) maxLen = c.length; });
      });
      // Add a bit of buffer
      maxLen += 2;

      for (const [section, commands] of Object.entries(helpMap)) {
        print(section, 'warn');
        commands.forEach(([cmd, desc]) => {
          let paddedCmd = cmd.padEnd(maxLen, ' ');
          paddedCmd = paddedCmd.replace(/</g, '&lt;').replace(/>/g, '&gt;');
          print(`${paddedCmd} : ${desc}`);
        });
        print(' '); // spacer
      }
      break;
    case 'whoami':
      print('User: Brieuc Métairie', 'success');
      print('Role: Future SysAdmin & Network Expert');
      print('Location: France');
      break;
    case 'social':
      print('-----------------------------', 'info');
      print('LinkedIn: <a href="https://linkedin.com/in/brieuc-metairie" target="_blank" style="color:#00f">linkedin.com/in/brieuc-metairie</a>');
      print('GitHub:   <a href="https://github.com/brieuc-metairie" target="_blank" style="color:#00f">github.com/brieuc-metairie</a>');
      print('Email:    <a href="mailto:metairiebrieuc@gmail.com" style="color:#00f">metairiebrieuc@gmail.com</a>');
      print('-----------------------------', 'info');
      break;
    case 'projects':
      print('Redirecting to /activites.html...', 'warn');
      setTimeout(() => window.location.href = 'activites.html', 800);
      break;
    case 'contact':
      print('Opening secure channel...', 'warn');
      setTimeout(() => {
        overlay.classList.remove('open');
        const modal = document.getElementById('contactModal');
        if (modal) modal.showModal();
      }, 500);
      break;
    case 'cv':
      print('Downloading CV...', 'success');
      const link = document.createElement('a');
      link.href = 'assets/cv.pdf';
      link.download = 'CV_Brieuc_Metairie.pdf';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      break;

    // --- PHASE 5 FEATURES ---
    case 'theme':
      const mode = args[1];
      const consoleWin = document.querySelector('.console-window');
      if (mode === 'retro') {
        consoleWin.classList.add('theme-retro');
        consoleWin.classList.remove('theme-ocean', 'theme-dracula');
        if (matrixInterval) { clearInterval(matrixInterval); document.querySelector('.matrix-canvas')?.remove(); }
        print('Theme set to RETRO.', 'success');
      } else if (mode === 'ocean') {
        consoleWin.classList.add('theme-ocean');
        consoleWin.classList.remove('theme-retro', 'theme-dracula');
        if (matrixInterval) { clearInterval(matrixInterval); document.querySelector('.matrix-canvas')?.remove(); }
        print('Theme set to OCEAN.', 'success');
      } else if (mode === 'dracula') {
        consoleWin.classList.add('theme-dracula');
        consoleWin.classList.remove('theme-retro', 'theme-ocean');
        if (matrixInterval) { clearInterval(matrixInterval); document.querySelector('.matrix-canvas')?.remove(); }
        print('Theme set to DRACULA.', 'success');
      } else if (mode === 'matrix' || mode === 'green') {
        consoleWin.classList.remove('theme-retro', 'theme-ocean', 'theme-dracula');
        initMatrix();
        print('Theme set to MATRIX (Visuals ON).', 'success');
      } else {
        print('Usage: theme <retro|ocean|dracula|matrix>', 'warn');
      }
      break;
    case 'neofetch':
      print('            .-/+oossssoo+/-.               brieuc@portfolio', 'pre');
      print('        `:+ssssssssssssssssss+:`           ----------------', 'pre');
      print('      -+ssssssssssssssssssyyssss+-         OS: PortfolioOS Web 1.0', 'pre');
      print('    .ossssssssssssssssssdMMMNysssso.       Host: Browser', 'pre');
      print('   /ssssssssssshdmmNNmmyNMMMMhssssss/      Uptime: Forever', 'pre');
      print('  +ssssssssshmydMMMMMMMNddddyssssssss+     Packages: 1 (npm)', 'pre');
      print(' /sssssssshNMMMyhhyyyyhmNMMMNhssssssss/    Shell: JS-Shell zsh', 'pre');
      print('.ssssssssdMMMNhsssssssssshNMMMdssssssss.   Resolution: ' + window.innerWidth + 'x' + window.innerHeight, 'pre');
      print('+sssshhhyNMMNyssssssssssssyNMMMysssssss+   Theme: ' + (args[2] || 'Retro'), 'pre');
      print('ossyNMMMNyMMhsssssssssssssshmmmhssssssso   CPU: 100% Brain', 'pre');
      break;
    case 'cowsay':
      const txt = args.slice(1).join(' ') || 'Moo!';
      const len = txt.length;
      const line = '-'.repeat(len + 2);
      print(' ' + line, 'pre');
      print('< ' + txt + ' >', 'pre');
      print(' ' + line, 'pre');
      print('        \\   ^__^', 'pre');
      print('         \\  (oo)\\_______', 'pre');
      print('            (__)\\       )\\/\\', 'pre');
      print('                ||----w |', 'pre');
      print('                ||     ||', 'pre');
      break;
    case 'banner':
      print(' ______       _                   ', 'pre');
      print('|  _  \\     (_)                  ', 'pre');
      print('| |_) |_ __  _  ___  _   _  ___  ', 'pre');
      print('|  _ <| \'__| |/ _ \\| | | |/ __| ', 'pre');
      print('| |_) | |   | |  __/| |_| | (__  ', 'pre');
      print('|____/|_|   |_|\\___| \\__,_|\\___| ', 'pre');
      print('          |__/                 ', 'pre');
      break;
    case 'matrix': // Standalone command
      initMatrix();
      print('Wake up, Neo...', 'success');
      break;

    case 'shutdown':
      print('System halting...', 'error');
      setTimeout(() => {
        let overlay = document.querySelector('.shutdown-overlay');
        if (!overlay) {
          overlay = document.createElement('div');
          overlay.className = 'shutdown-overlay';
          overlay.innerText = "SYSTEM HALTED";
          document.body.appendChild(overlay);
        }
        // Trigger reflow
        overlay.offsetHeight;
        overlay.classList.add('active');
      }, 1000);
      break;

    case 'reboot':
      print('Rebooting system...', 'warn');
      setTimeout(() => location.reload(), 1000);
      break;
    case 'calc':
      const expr = args.slice(1).join('');
      if (!expr) {
        print('Usage: calc <expression> (ex: 2+2)', 'warn');
      } else {
        try {
          if (/[^0-9+\-*/().]/.test(expr)) {
            print('Error: Invalid characters.', 'error');
          } else {
            const result = new Function('return ' + expr)();
            print(`${expr} = ${result}`, 'success');
          }
        } catch (e) {
          print('Error: Invalid expression.', 'error');
        }
      }
      break;
    case 'vim':
    case 'vi':
      print('You are trapped in a text editor.', 'error');
      print('Press ESC to exit...', 'info');
      setTimeout(() => print('Just kidding. Type :q! to quit.', 'info'), 1500);
      break;
    case ':q!':
    case ':q':
      print('Phew! You escaped.', 'success');
      break;
    case 'sudo':
      if (args[1] === 'rm' && args[2] === '-rf' && args[3] === '/') {
        triggerBSOD();
      } else if (args[1] === 'su' || args[1] === '-i') {
        print('Password for brieuc:', 'warn');
        setTimeout(() => {
          print('******', 'info');
          setTimeout(() => {
            print('Switched to user root', 'success');
            currentUser = 'root';
            document.getElementById('promptPath').innerText = 'root@brieuc:~#';
          }, 800);
        }, 1000);
      } else {
        print('Permission denied: You are not root.', 'error');
      }
      break;
    /* ls handled above */
    case 'su':
      executeCommand('sudo su');
      break;
    case 'rm':
      if (currentUser === 'root' && args[1] === '-rf' && args[2] === '/') {
        triggerBSOD();
      } else if (currentUser !== 'root') {
        print('Permission denied: You are not root.', 'error');
      } else {
        print('Usage: rm -rf / (Do not try this)', 'warn');
      }
      break;

    // --- SYSADMIN ---
    case 'history':
      print(commandHistory.map((c, i) => `${i + 1}  ${c}`).join('<br>'), 'info');
      break;
    case 'ping': {
      const target = args[1] || 'google.com';
      print(`Pinging ${target} [142.250.178.14] with 32 bytes of data:`);
      let pings = 0;
      const pingInterval = setInterval(() => {
        if (pings >= 4) {
          clearInterval(pingInterval);
          print(`Ping statistics for ${target}:`, 'info');
          return;
        }
        const time = Math.floor(Math.random() * 20) + 10;
        print(`Reply from 142.250.178.14: bytes=32 time=${time}ms TTL=115`);
        pings++;
      }, 800);
      break;
    }
    case 'ipconfig':
      print('Windows IP Configuration');
      print('IPv4 Address. . . . . . . . . . . : 192.168.1.42');
      break;
    case 'date':
      print(new Date().toString());
      break;
    case 'curl':
      if (!args[1]) { print('curl: try \'curl <url>\'', 'warn'); }
      else {
        print(`Checking ${args[1]}...`, 'info');
        setTimeout(() => {
          print('&lt;html&gt;&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;center&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;&lt;/center&gt;&lt;/body&gt;&lt;/html&gt;', 'success');
        }, 400);
      }
      break;
    case 'whois':
      const domain = args[1] || 'brieuc-metairie.fr';
      print('Domain Name: ' + domain.toUpperCase());
      print('Registry Domain ID: 8675309');
      print('Registrar WHOIS Server: whois.google.com');
      print('Registrar URL: http://www.google.com');
      print('Registrar: Google LLC');
      break;
    case 'top':
      print('PID USER      PR  NI  VIRT  RES  SHR S  %CPU %MEM    TIME+ COMMAND', 'pre');
      print('  1 root      20   0  1.2g 123m  45m S   0.0  1.2   0:01.23 init', 'pre');
      print(' 42 brieuc    20   0  8.5g 4.2g 1.1g S  12.4 45.1  12:34.56 chrome', 'pre');
      print(' 55 brieuc    20   0  2.1g 345m  56m S   4.2  3.5   1:05.12 vscode', 'pre');
      print(' 77 root      20   0  56m   4m   1m S   0.1  0.0   0:00.05 sshd', 'pre');
      break;
    case 'htop':
      print('CPU[| 23%] MEM[|| 1.2G]');
      break;
    case 'weather':
      const cities = ['Server Room', 'Paris', 'Tokyo', 'New York', 'Mars Colony'];
      const temps = ['19°C', '12°C', '28°C', '-5°C', '-60°C'];
      const icons = ['🌡️', '☁️', '☀️', '❄️', '🚀'];
      const r = Math.floor(Math.random() * cities.length);
      setTimeout(() => {
        print(icons[r] + ' ' + cities[r] + ': ' + temps[r]);
      }, 500);
      break;

    // --- GAMES ---
    case 'snake': {
      print('Starting Snake... (Arrow Keys)', 'success');
      const sCanvas = document.createElement('canvas');
      sCanvas.width = 300;
      sCanvas.height = 300;
      sCanvas.style.border = '2px solid #0f0';
      sCanvas.style.marginTop = '10px';
      sCanvas.style.background = '#000';
      output.appendChild(sCanvas);
      body.scrollTop = body.scrollHeight;
      const sCtx = sCanvas.getContext('2d');
      let snake = [{ x: 10, y: 10 }];
      let food = { x: 15, y: 15 };
      let dx = 0; let dy = 0; let score = 0;
      const tile = 15;
      const tileCount = sCanvas.width / tile;
      const drawSnake = () => {
        sCtx.fillStyle = '#000'; sCtx.fillRect(0, 0, 300, 300);
        sCtx.fillStyle = '#f00'; sCtx.fillRect(food.x * tile, food.y * tile, tile - 2, tile - 2);
        sCtx.fillStyle = '#0f0'; snake.forEach(p => sCtx.fillRect(p.x * tile, p.y * tile, tile - 2, tile - 2));
        const head = { x: snake[0].x + dx, y: snake[0].y + dy };
        snake.unshift(head);
        if (head.x === food.x && head.y === food.y) {
          score++; food = { x: Math.floor(Math.random() * tileCount), y: Math.floor(Math.random() * tileCount) };
        } else snake.pop();
        if (head.x < 0 || head.x >= tileCount || head.y < 0 || head.y >= tileCount) {
          clearInterval(gameInterval); print(`Game Over.Score: ${score} `, 'error'); sCanvas.remove();
        }
      };
      const keyDownEvent = (e) => {
        if (e.key === 'ArrowLeft' && dx !== 1) { dx = -1; dy = 0; } if (e.key === 'ArrowUp' && dy !== 1) { dx = 0; dy = -1; }
        if (e.key === 'ArrowRight' && dx !== -1) { dx = 1; dy = 0; } if (e.key === 'ArrowDown' && dy !== -1) { dx = 0; dy = 1; }
      };
      document.addEventListener('keydown', keyDownEvent);
      const gameInterval = setInterval(drawSnake, 100);
      const stopGame = () => { clearInterval(gameInterval); document.removeEventListener('keydown', keyDownEvent); };
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') stopGame(); }, { once: true });
      break;
    }

    case 'invaders': {
      print('Space Invaders launched.', 'success');
      const iCanvas = document.createElement('canvas');
      iCanvas.width = 300; iCanvas.height = 300;
      iCanvas.style.border = '2px solid #0f0'; iCanvas.style.background = '#000';
      output.appendChild(iCanvas);
      const iCtx = iCanvas.getContext('2d');
      let iScore = 0;
      let player = { x: 135, y: 270, w: 30, h: 10 };
      let bullets = [];
      let enemies = [];
      for (let r = 0; r < 3; r++) { for (let c = 0; c < 6; c++) enemies.push({ x: 30 + c * 40, y: 30 + r * 30, w: 20, h: 20, alive: true }); }
      let dx = 2; // Enemy speed
      const drawInvaders = () => {
        iCtx.fillStyle = '#000'; iCtx.fillRect(0, 0, 300, 300);

        // Player (Retro Ship)
        iCtx.fillStyle = '#0f0';
        iCtx.fillRect(player.x + 10, player.y, 10, 5); // Top
        iCtx.fillRect(player.x, player.y + 5, 30, 5);  // Bottom

        // Bullets
        iCtx.fillStyle = '#fff';
        bullets.forEach((b, i) => {
          b.y -= 5;
          iCtx.fillRect(b.x, b.y, 2, 8);
          if (b.y < 0) bullets.splice(i, 1)
        });

        // Enemies (Invader Sprite)
        let edge = false;
        iCtx.fillStyle = '#f00';
        enemies.forEach(e => {
          if (e.alive) {
            // Draw Alien
            iCtx.fillRect(e.x + 5, e.y, 10, 5);
            iCtx.fillRect(e.x, e.y + 5, 20, 10);
            iCtx.fillRect(e.x, e.y + 15, 5, 5);
            iCtx.fillRect(e.x + 15, e.y + 15, 5, 5);

            // Collision
            bullets.forEach((b, bi) => {
              if (b.x > e.x && b.x < e.x + e.w && b.y > e.y && b.y < e.y + e.h) {
                e.alive = false;
                bullets.splice(bi, 1);
                iScore += 10;
              }
            });

            // Movement Logic
            e.x += dx;
            if (e.x + e.w > 300 || e.x < 0) edge = true;
          }
        });

        if (edge) {
          dx = -dx;
          enemies.forEach(e => e.y += 10);
        }

        // HUD
        iCtx.fillStyle = '#fff';
        iCtx.font = '10px monospace';
        iCtx.fillText('SCORE: ' + iScore, 10, 15);
      };
      const iKeyEvents = (e) => {
        if (e.key === 'ArrowLeft' && player.x > 0) player.x -= 15;
        if (e.key === 'ArrowRight' && player.x < 270) player.x += 15;
        if (e.key === ' ') bullets.push({ x: player.x + 13, y: player.y - 10 });
      };
      document.addEventListener('keydown', iKeyEvents);
      const invInt = setInterval(drawInvaders, 50);
      const stopInv = () => { clearInterval(invInt); document.removeEventListener('keydown', iKeyEvents); };
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') stopInv(); }, { once: true });
      break;
    }

    case 'game':
      print('Guess the number (0-100). Type "guess [number]".');
      window.targetNumber = Math.floor(Math.random() * 101);
      break;
    case 'coffee':
      print('Here is your coffee! ☕', 'success');
      break;
    case 'fortune':
      print('"It works on my machine."', 'success');
      break;
    case 'matrix':
      print('Wake up, Neo...', 'success');
      initMatrixEffect();
      break;
    case 'hack':
      print('Hacking in progress... [████████] 100%', 'success');
      break;
    case 'shutdown':
      print('Rebooting...', 'warn');
      setTimeout(() => location.reload(), 2000);
      break;
    case 'date':
      print(new Date().toString());
      break;
    case 'clear':
      output.innerHTML = '';
      break;
    case 'exit':
      overlay.classList.remove('open');
      break;
    case '':
      break;
    case 'echo':
      print(args.slice(1).join(' '), 'info');
      break;
    case 'credits':
      print('Portfolio created by Brieuc Métairie.', 'success');
      print('Built with HTML, CSS (Variables), and Vanilla JS.', 'info');
      print('Inspired by retro terminals and modern cyber-security UIs.', 'info');
      break;
    case 'email':
      print('metairiebrieuc@gmail.com', 'info');
      break;
    case 'man':
      if (!args[1]) {
        print('What manual page do you want? (Usage: man <command>)', 'warn');
      } else {
        const cmdToFind = args[1];
        const manuals = {
          'alias': 'Define or display aliases. Usage: alias <name>=<cmd>',
          'banner': 'Display the system logo.',
          'calc': 'Evaluate mathematical expressions. Usage: calc <expr>',
          'cat': 'Concatenate and display file content. Usage: cat <file>',
          'cd': 'Change the current directory. Usage: cd <dir>',
          'clear': 'Clear the terminal screen.',
          'coffee': 'Brew a fresh cup of coffee. Usage: coffee',
          'contact': 'Display contact information form.',
          'cowsay': 'Display a message spoken by a cow. Usage: cowsay <text>',
          'credits': 'Show project credits and author info.',
          'currency': 'Convert currency. Usage: currency <amt> <from> <to>',
          'cv': 'Download the curriculum vitae (PDF).',
          'date': 'Display the current system date and time.',
          'echo': 'Display a line of text. Usage: echo <text>',
          'email': 'Display the author\'s email address.',
          'exit': 'Close the terminal session.',
          'fact': 'Display a random interesting fact.',
          'flip': 'Flip a coin (Heads/Tails).',
          'fortune': 'Display a random quote or fortune.',
          'game': 'Play a number guessing game.',
          'gui': 'Attempt to launch the Graphical User Interface.',
          'help': 'Display information about builtin commands.',
          'history': 'Display the command history list.',
          'invaders': 'Play the Space Invaders game.',
          'joke': 'Tell a programming joke.',
          'ls': 'List directory contents.',
          'man': 'Format and display the on-line manual pages.',
          'matrix': 'Toggle the Matrix digital rain visual effect.',
          'neofetch': 'Display system information.',
          'password': 'Generate a secure password. Usage: password <len>',
          'ping': 'Send ICMP ECHO_REQUEST to network hosts. Usage: ping <url>',
          'pomodoro': 'Start a 25-minute Pomodoro timer.',
          'projects': 'Navigate to the projects page.',
          'pwd': 'Print name of current/working directory.',
          'reboot': 'Restart the system.',
          'roll': 'Roll a die. Usage: roll <sides>',
          'shutdown': 'Bring the system down.',
          'snake': 'Play the Snake game.',
          'social': 'Display social media links.',
          'stats': 'Display session statistics.',
          'sudo': 'Execute a command as another user.',
          'sysinfo': 'Display detailed browser and system info.',
          'theme': 'Set the color theme. Usage: theme <name>',
          'todo': 'Manage tasks. Usage: todo <add|list|del>',
          'top': 'Display processes (mock).',
          'uptime': 'Tell how long the system has been running.',
          'weather': 'Display current weather conditions (mock).',
          'whoami': 'Print effective userid.',
          'whois': 'Query a domain name database.'
        };
        if (manuals[cmdToFind]) {
          print('NAME', 'pre');
          print(`    ${cmdToFind} - ${manuals[cmdToFind]}`, 'info');
        } else {
          print(`No manual entry for ${cmdToFind}`, 'error');
        }
      }
      break;
    case 'uptime':
      const uptime = Math.floor((Date.now() - startTime) / 1000);
      const m = Math.floor(uptime / 60);
      const s = uptime % 60;
      print(`System up for ${m} minutes and ${s} seconds.`, 'info');
      break;
    case 'todo':
      const action = args[1];
      if (action === 'add') {
        const task = args.slice(2).join(' ');
        if (task) {
          todoList.push(task);
          print(`Task added: "${task}"`, 'success');
        } else print('Usage: todo add <task>', 'warn');
      } else if (action === 'list') {
        if (todoList.length === 0) print('No tasks yet.', 'info');
        else {
          print('TODO LIST:', 'warn');
          todoList.forEach((t, i) => print(`${i + 1}. ${t}`, 'info'));
        }
      } else if (action === 'del') {
        const idx = parseInt(args[2]) - 1;
        if (!isNaN(idx) && todoList[idx]) {
          print(`Deleted: "${todoList[idx]}"`, 'error');
          todoList.splice(idx, 1);
        } else print('Usage: todo del <number>', 'warn');
      } else {
        print('Usage: todo <add|list|del>', 'warn');
      }
      break;
    case 'alias':
      if (!args[1]) {
        print('Current Aliases:', 'warn');
        Object.keys(aliases).forEach(k => print(`${k}=${aliases[k]}`, 'info'));
      } else {
        const pair = args.slice(1).join(' ').split('=');
        if (pair.length === 2) {
          aliases[pair[0].trim()] = pair[1].trim();
          print(`Alias set: ${pair[0]} -> ${pair[1]}`, 'success');
        } else print('Usage: alias <name>=<command>', 'warn');
      }
      break;
    case 'joke':
      const jokes = [
        'Why do programmers prefer dark mode? Because light attracts bugs.',
        'How many programmers does it take to change a light bulb? None, that\'s a hardware problem.',
        'I told my wife she was drawing her eyebrows too high. She looked surprised.',
        'There are 10 types of people in the world: those who understand binary, and those who don\'t.',
        'A SQL query walks into a bar, walks up to two tables and asks, "Can I join you?"'
      ];
      print(jokes[Math.floor(Math.random() * jokes.length)], 'success');
      break;
    case 'hack':
      print('Initiating brute-force attack on NSA servers...', 'warn');
      let hCount = 0;
      const hInt = setInterval(() => {
        if (hCount > 20) {
          clearInterval(hInt);
          print('ACCESS DENIED. Connection terminated by host.', 'error');
        } else {
          print(`[${Math.random().toString(16).substr(2, 8)}] Uploading payload... ${hCount * 5}%`, 'info');
          const output = document.querySelector('.console-output');
          output.scrollTop = output.scrollHeight;
          hCount++;
        }
      }, 150);
      break;
    case 'roll':
      const sides = parseInt(args[1]) || 6;
      print(`You rolled a ${Math.floor(Math.random() * sides) + 1} (d${sides})`, 'success');
      break;
    case 'flip':
      print(Math.random() > 0.5 ? 'Heads' : 'Tails', 'success');
      break;
    case 'fact':
      const facts = [
        'The first computer bug was an actual moth.',
        'JavaScript was created in 10 days.',
        'The QWERTY layout was designed to slow you down.',
        '90% of the world\'s currency is digital.',
        'The first domain name ever registered was Symbolics.com.'
      ];
      print(facts[Math.floor(Math.random() * facts.length)], 'info');
      break;
    case 'currency':
      if (args.length < 4) {
        print('Usage: currency <amount> <from> <to> (e.g., 100 USD EUR)', 'warn');
      } else {
        const amt = parseFloat(args[1]);
        const from = args[2].toUpperCase();
        const to = args[3].toUpperCase();
        const rates = { 'USD': 1, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 150 };
        if (rates[from] && rates[to]) {
          const res = (amt / rates[from]) * rates[to];
          print(`${amt} ${from} = ${res.toFixed(2)} ${to}`, 'success');
        } else print('Unsupported currency. (Try USD, EUR, GBP, JPY)', 'error');
      }
      break;
    case 'pomodoro':
      print('Starting 25-minute timer...', 'info');
      let pTime = 25 * 60;
      const pInt = setInterval(() => {
        pTime--;
        if (pTime <= 0) {
          clearInterval(pInt);
          print('Pomodoro complete! Take a break.', 'success');
          new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(() => { });
        } else if (pTime % 300 === 0) {
          print(`${pTime / 60} minutes remaining...`, 'info');
        }
      }, 1000);
      break;
    case 'password': {
      const len = parseInt(args[1]) || 12;
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()';
      let pwd = '';
      for (let i = 0; i < len; i++) pwd += chars.charAt(Math.floor(Math.random() * chars.length));
      print(`Generated Password: ${pwd}`, 'success');
      break;
    }
    case 'sysinfo':
      print('Browser: ' + navigator.userAgent, 'info');
      print('Language: ' + navigator.language, 'info');
      print('Platform: ' + navigator.platform, 'info');
      print('Cores: ' + (navigator.hardwareConcurrency || 'Unknown'), 'info');
      break;
    case 'gui':
      print('GUI? We don\'t do that here. CLI is life. 🐧', 'success');
      break;
    case 'stats':
      print('--- SESSION STATS ---', 'warn');
      print(`Commands Run: ${commandHistory.length}`, 'info');
      const uptimeS = Math.floor((Date.now() - startTime) / 1000);
      print(`Uptime: ${Math.floor(uptimeS / 60)}m ${uptimeS % 60}s`, 'info');
      break;
    default:
      if (cmd.startsWith('guess ')) {
        const guess = parseInt(cmd.split(' ')[1]);
        if (isNaN(guess)) { print('Invalid number.', 'error'); return; }
        if (!window.targetNumber && window.targetNumber !== 0) { print('Start game first with "game".', 'error'); return; }
        if (guess === window.targetNumber) {
          print(`🎉 WIN! The number was ${window.targetNumber}.`, 'success'); window.targetNumber = null;
        } else if (guess < window.targetNumber) {
          print('Higher ↑', 'warn');
        } else {
          print('Lower ↓', 'warn');
        }
        return;
      }
      print(`Command not found: ${command} `, 'error');
  }
};

// 4. Event Listeners
trigger.addEventListener('click', () => {
  overlay.classList.add('open');
  input.focus();
});

closeBtn.addEventListener('click', () => {
  overlay.classList.remove('open');
});

overlay.addEventListener('click', (e) => {
  if (e.target === overlay) overlay.classList.remove('open');
});

input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    executeCommand(input.value);
    input.value = '';
    historyIndex = -1; // Reset navigation
  } else if (e.key === 'Tab') {
    e.preventDefault();
    const val = input.value; // Don't trim to allow typing arguments, but for command completion we care about start
    const args = val.split(' ');
    const prefix = args[args.length - 1]; // Autocomplete last word? Or just command?
    // Let's just autocomplete the COMMAND for now (first word)
    if (args.length > 1) return; // Only autocomplete command

    const potentialCommands = ['ls', 'cd', 'cat', 'pwd', 'clear', 'whoami', 'social', 'cv', 'projects', 'contact', 'ping', 'ipconfig', 'htop', 'weather', 'date', 'invaders', 'snake', 'game', 'theme', 'calc', 'coffee', 'fortune', 'sudo', 'exit', 'shutdown', 'matrix', 'hack', 'vim', 'help'];

    const matches = potentialCommands.filter(c => c.startsWith(val));

    if (matches.length === 1) {
      input.value = matches[0] + ' ';
    } else if (matches.length > 1) {
      print(matches.join('  '), 'info');
    }
  } else if (e.key === 'Tab') {
    e.preventDefault();
    const current = input.value.trim();
    if (!current) return;

    const allCmds = [
      'alias', 'banner', 'calc', 'cat', 'cd', 'clear', 'coffee', 'contact', 'cowsay',
      'credits', 'currency', 'cv', 'date', 'echo', 'email', 'exit', 'fact', 'flip',
      'fortune', 'game', 'gui', 'hack', 'help', 'history', 'invaders', 'joke', 'ls', 'man',
      'matrix', 'neofetch', 'password', 'ping', 'pomodoro', 'projects', 'pwd',
      'reboot', 'roll', 'shutdown', 'snake', 'social', 'stats', 'sudo', 'sysinfo',
      'theme', 'todo', 'top', 'uptime', 'weather', 'whoami', 'whois'
    ];

    const matches = allCmds.filter(c => c.startsWith(current));
    if (matches.length === 1) {
      input.value = matches[0] + ' ';
    } else if (matches.length > 1) {
      print(matches.join('   '), 'info');
    }
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    if (commandHistory.length > 0) {
      if (historyIndex === -1) historyIndex = commandHistory.length;
      if (historyIndex > 0) historyIndex--;
      input.value = commandHistory[historyIndex];
    } else {
      // No history
    }
  } else if (e.key === 'ArrowDown') {
    e.preventDefault();
    if (historyIndex !== -1 && historyIndex < commandHistory.length - 1) {
      historyIndex++;
      input.value = commandHistory[historyIndex];
    } else {
      historyIndex = commandHistory.length;
      input.value = '';
    }
  }
});
}

// Matrix Effect Implementation
function initMatrixEffect() {
  const canvas = document.createElement('canvas');
  canvas.classList.add('matrix-canvas');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  canvas.style.position = 'fixed';
  canvas.style.top = '0';
  canvas.style.left = '0';
  canvas.style.zIndex = '9998';
  canvas.style.pointerEvents = 'none';
  document.body.appendChild(canvas);

  const ctx = canvas.getContext('2d');
  const cols = Math.floor(canvas.width / 20);
  const ypos = Array(cols).fill(0);

  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  const matrixInterval = setInterval(() => {
    ctx.fillStyle = '#0001';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = '#0f0';
    ctx.font = '15pt monospace';

    ypos.forEach((y, ind) => {
      const text = String.fromCharCode(Math.random() * 128);
      const x = ind * 20;
      ctx.fillText(text, x, y);
      if (y > 100 + Math.random() * 10000) ypos[ind] = 0;
      else ypos[ind] = y + 20;
    });
  }, 50);

  setTimeout(() => {
    clearInterval(matrixInterval);
    canvas.remove();
  }, 10000); // Run for 10 seconds
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  initConsole();
});

// =========================================
//  MOBILE MENU UX
// =========================================
document.addEventListener('DOMContentLoaded', () => {
  const navToggle = document.querySelector('.nav-toggle');
  const navLinks = document.querySelector('.nav-links');

  if (navToggle && navLinks) {
    navToggle.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent immediate close
      navToggle.classList.toggle('open');
      navLinks.classList.toggle('open');
    });

    // Close when clicking a link
    navLinks.querySelectorAll('a').forEach(link => {
      link.addEventListener('click', () => {
        navLinks.classList.remove('open');
        navToggle.classList.remove('open');
      });
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      if (navLinks.classList.contains('open') &&
        !navLinks.contains(e.target) &&
        !navToggle.contains(e.target)) {
        navLinks.classList.remove('open');
        navToggle.classList.remove('open');
      }
    });
  }
});
